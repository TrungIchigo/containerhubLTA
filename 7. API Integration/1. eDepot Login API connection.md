### **Phần 1: Luồng Nghiệp Vụ & Xác Thực (Business & Authentication Flow)**

**Đây là những gì sẽ xảy ra "dưới mui xe" khi người dùng nhấn nút "Đăng Nhập":**

1. **[Frontend - User]** Người dùng nhập username (ví dụ: 020202022) và password (098765) vào form đăng nhập của **i-ContainerHub**.
2. **[Frontend -> Backend]** Form đăng nhập của chúng ta gửi thông tin này đến một **Server Action** hoặc **API Route** đặc biệt của i-ContainerHub (ví dụ: /api/auth/edepot-login).
3. **[Backend - i-ContainerHub]** Server Action của chúng ta nhận được username và password.
4. **[Backend - i-ContainerHub -> eDepot API]** Backend của chúng ta sẽ đóng vai trò là một client, thực hiện một lệnh gọi POST đến API của eDepot: https://apiedepottest.gsotgroup.vn/api/Users/Login với body chứa username và password đó.
5. **[eDepot API -> Backend - i-ContainerHub]** eDepot API xử lý và trả về kết quả.
    - **Kịch bản 5A: Thất bại (Sai user/pass):** eDepot API sẽ trả về lỗi (ví dụ: mã lỗi 401 hoặc 400). Backend của chúng ta sẽ bắt lỗi này và trả về thông báo "Thông tin đăng nhập không chính xác" cho người dùng.
    - **Kịch bản 5B: Thành công:** eDepot API trả về mã 200 OK cùng với token và username.
6. **[Backend - i-ContainerHub] Xử lý sau khi xác thực thành công:**
    - **Đây là bước quan trọng nhất.** Chúng ta **không thể và không nên** lưu lại password của người dùng. Nhưng chúng ta cần một cách để nhận diện và cấp quyền cho người dùng này trong hệ thống của chúng ta.
    - **Bước 6.1 (Tìm kiếm Người dùng):** Hệ thống sẽ tìm trong bảng profiles của mình xem đã có người dùng nào được liên kết với username từ eDepot chưa (chúng ta cần thêm một cột mới để lưu trữ ID này).
    - **Bước 6.2 (Tạo Người dùng "Just-in-Time" - Nếu chưa tồn tại):**
        - Nếu không tìm thấy, hệ thống sẽ tự động tạo một cặp tài khoản mới trên **Supabase Auth** và **profiles**.
        - Tài khoản mới này có thể có một email giả lập (ví dụ: 020202022@edepot.user) và một mật khẩu ngẫu nhiên, an toàn (vì người dùng sẽ không bao giờ dùng nó để đăng nhập trực tiếp).
        - Cột edepot_username mới trong bảng profiles sẽ được điền giá trị 020202022.
    - **Bước 6.3 (Tạo Phiên làm việc Supabase):**
        - Dù là người dùng cũ hay mới tạo, bây giờ chúng ta đã có userId của họ trên hệ thống Supabase.
        - Backend của chúng ta sẽ sử dụng quyền **Admin** của Supabase để **tạo ra một phiên làm việc (session) mới** cho người dùng này. Đây là một kỹ thuật gọi là "Impersonation" hoặc "Custom JWT".
7. **[Backend -> Frontend]** Server Action trả về session của Supabase cho trình duyệt.
8. **[Frontend]** Trình duyệt lưu lại session này vào cookie. Người dùng được đăng nhập thành công vào i-ContainerHub và được điều hướng đến dashboard.

### **Phần 2: Mô Tả Chi Tiết Để AI Code**

### **Task 2.1: Cập Nhật CSDL**

- **Mục tiêu:** Thêm một cột để liên kết tài khoản i-ContainerHub với tài khoản eDepot.
- **Yêu cầu (Code SQL):**codeSQL
    
    ```
    ALTER TABLE public.profiles
    ADD COLUMN edepot_username TEXT UNIQUE;
    
    COMMENT ON COLUMN public.profiles.edepot_username IS 'Lưu trữ username từ hệ thống eDepot để liên kết tài khoản.';
    ```
    

### **Task 2.2: Cập Nhật Giao Diện Đăng Nhập (Tùy chọn)**

- **Mục tiêu:** Cung cấp lựa chọn đăng nhập.
- **Giải pháp:** Thêm một <Tabs> trên form đăng nhập:
    - Tab 1: **"Đăng nhập bằng tài khoản i-ContainerHub"** (form hiện tại với Email/Password).
    - Tab 2: **"Đăng nhập bằng tài khoản eDepot"** (form mới với User/Password).

### **Task 2.3: Tạo Server Action Xử Lý Đăng Nhập eDepot**

- **File cần tạo/cập nhật:** src/app/auth.actions.ts
- **Yêu cầu:** Tạo một Server Action mới loginWithEdepot.codeTypeScript
    
    ```
    'use server';
    
    import { createClient } from '@/lib/supabase/server';
    import { cookies } from 'next/headers';
    import { randomBytes } from 'crypto';
    
    export async function loginWithEdepot(formData: FormData) {
      const username = formData.get('username') as string;
      const password = formData.get('password') as string;
      const cookieStore = cookies();
      const supabase = createClient(cookieStore);
    
      // Bước 1: Gọi API của eDepot để xác thực
      const edepotApiResponse = await fetch('https://apiedepottest.gsotgroup.vn/api/Users/Login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user: username, password: password }),
      });
    
      if (!edepotApiResponse.ok) {
        return { error: 'Thông tin đăng nhập eDepot không chính xác.' };
      }
    
      const edepotData = await edepotApiResponse.json();
      const edepotToken = edepotData.token; // Có thể lưu lại token này nếu cần gọi các API khác của eDepot sau này
    
      // Bước 2: Tìm hoặc Tạo người dùng trên i-ContainerHub
      let { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('id, organization_id, role, email') // Lấy các thông tin cần thiết
        .eq('edepot_username', username)
        .single();
    
      if (!profile) {
        // --- Logic Tự động Tạo tài khoản (Just-in-Time Provisioning) ---
        // TODO: Cần có logic để xác định người dùng mới này thuộc tổ chức nào, vai trò gì
        // Ví dụ, có thể gọi một API khác của eDepot để lấy thông tin chi tiết của user
        // Giả sử ở đây chúng ta gán họ vào một tổ chức mặc định và vai trò DISPATCHER
        const defaultOrgId = 'uuid-cua-to-chuc-mac-dinh'; // THAY THẾ ID NÀY
        const userEmail = `${username}@edepot.user`; // Email giả lập, duy nhất
    
        const { data: newUser, error: signUpError } = await supabase.auth.admin.createUser({
          email: userEmail,
          password: randomBytes(16).toString('hex'), // Mật khẩu ngẫu nhiên, an toàn
          email_confirm: true, // Tự động xác thực email
        });
    
        if (signUpError) { throw signUpError; }
    
        const { data: newProfile, error: newProfileError } = await supabase
          .from('profiles')
          .insert({
            id: newUser.user.id,
            edepot_username: username,
            full_name: `eDepot User ${username}`, // Có thể lấy tên thật từ API khác của eDepot
            organization_id: defaultOrgId,
            role: 'DISPATCHER',
          })
          .select('id, organization_id, role, email')
          .single();
    
        if (newProfileError) { throw newProfileError; }
        profile = newProfile;
      }
    
      // Bước 3: Tạo session trên Supabase cho người dùng đã được xác định
      // Kỹ thuật này sử dụng magic link để đăng nhập người dùng từ backend một cách an toàn
      const { data, error: linkError } = await supabase.auth.admin.generateLink({
          type: 'magiclink',
          email: profile.email
      });
    
      if(linkError) { throw linkError; }
    
      const { data: { session }, error: sessionError } = await supabase.auth.verifyOtp({
          type: 'magiclink',
          token_hash: data.properties.hashed_token,
      });
    
      if(sessionError) { throw sessionError; }
    
      if(session){
        await supabase.auth.setSession(session);
      } else {
        throw new Error('Không thể tạo session cho người dùng.');
      }
    
      return { error: null, redirectTo: '/dispatcher' }; // Báo cho client điều hướng
    }
    ```
    
    - **Lưu ý quan trọng về bảo mật:** Việc sử dụng các hàm supabase.auth.admin yêu cầu mã của bạn phải đang chạy với quyền **Service Role Key** của Supabase. Điều này là an toàn khi thực hiện trong Server Actions.

Bằng cách triển khai luồng này, bạn sẽ tạo ra một trải nghiệm đăng nhập liền mạch và an toàn cho người dùng từ hệ sinh thái eDepot, là một bước tiến lớn trong việc tích hợp các hệ thống.