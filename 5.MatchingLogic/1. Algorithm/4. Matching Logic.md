## Logic Ghép nối mới ##

### **Mô Tả Chi Tiết: Tái Cấu Trúc Thuật Toán Ghép Nối 1-Nhiều & Hệ Thống Tính Điểm**

**Mục tiêu tổng thể:** Xây dựng một thuật toán có khả năng, với mỗi "Lệnh Giao Trả" (LGT) đang sẵn sàng, quét qua TOÀN BỘ các "Lệnh Lấy Rỗng" (LLR) tiềm năng (cả nội bộ và marketplace), tính điểm cho từng cặp, và trả về một cấu trúc dữ liệu phân cấp (1-nhiều) đã được sắp xếp.

### **Phần 1: Cấu Trúc Dữ Liệu Đầu Ra (The Data Structure)**

Trước khi viết thuật toán, chúng ta cần xác định "sản phẩm" cuối cùng nó sẽ tạo ra. Kết quả trả về sẽ không phải là một danh sách các cặp đơn lẻ nữa, mà là một **mảng các đối tượng "Lệnh Giao Trả"**, trong đó mỗi đối tượng chứa một mảng con các **"Cơ hội Ghép nối"**.

**Ví dụ cấu trúc dữ liệu JSON đầu ra:**

Generated json

`[
  // Đối tượng Lệnh Giao Trả thứ 1
  {
    "dropOffOrder": {
      "id": "lgt-id-001",
      "containerNumber": "MSKU1234567",
      "location": "KCN Sóng Thần, Bình Dương",
      // ... các thông tin khác của LGT ...
    },
    "matchingOpportunities": [
      // Cơ hội ghép nối thứ 1 cho LGT-001
      {
        "pickupOrder": { "id": "llr-id-101", "bookingNumber": "BKG-A", "location": "KCN Tân Tạo, HCM" },
        "overallScore": 85,
        "scenarioType": "Nội bộ",
        "scoreDetails": { "distance": 38, "time": 19, "complexity": 12, "quality": 15 },
        "extraTasks": [],
        "estimatedCosts": []
      },
      // Cơ hội ghép nối thứ 2 cho LGT-001
      {
        "pickupOrder": { "id": "llr-id-202", "bookingNumber": "BKG-B", "location": "KCN Quế Võ, Bắc Ninh" },
        "overallScore": 35,
        "scenarioType": "Kết hợp COD",
        "scoreDetails": { "distance": 0, "time": 18, "complexity": 5, "quality": 15 },
        "extraTasks": ["Yêu cầu COD về Depot X"],
        "estimatedCosts": [{ "type": "COD_FEE", "amount": 350000 }]
      }
      // ... các cơ hội khác ...
    ]
  },
  // Đối tượng Lệnh Giao Trả thứ 2
  {
    "dropOffOrder": {
      "id": "lgt-id-002",
      // ...
    },
    "matchingOpportunities": [
      // ... danh sách cơ hội của LGT-002 ...
    ]
  }
]`

### **Phần 2: Mô Tả Thuật Toán Chi Tiết (Để AI Code)**

Đây là logic sẽ được đặt trong một hàm (ví dụ: generateMatchingSuggestions) ở phía server.

**Đầu vào của thuật toán:**

- user_organization_id: ID của công ty vận tải đang xem.

**Các bước xử lý:**

1. **Thu thập Dữ liệu Nguồn:**
    - **Lấy Lệnh Giao Trả (LGT):** SELECT * FROM import_containers WHERE trucking_company_org_id = user_organization_id AND status = 'AVAILABLE'.
    - **Lấy Lệnh Lấy Rỗng (LLR) - Bao gồm cả nội bộ và marketplace:**
        - SELECT * FROM export_bookings WHERE status = 'AVAILABLE'. (Lấy tất cả các lệnh lấy rỗng đang sẵn sàng trên toàn hệ thống).
2. **Khởi tạo Cấu trúc Kết quả:**
    - Tạo một mảng rỗng: let results = [].
3. **Vòng lặp chính - Lặp qua từng Lệnh Giao Trả (Outer Loop):**
    - FOR each dropOffOrder in Lệnh_Giao_Trả_List:
        - Tạo một đối tượng suggestionGroup mới:Generated javascript
            
            `let suggestionGroup = {
              dropOffOrder: dropOffOrder,
              matchingOpportunities: []
            };`
            
    
4. **Vòng lặp Phụ - Lặp qua từng Lệnh Lấy Rỗng (Inner Loop):**
    - FOR each pickupOrder in Lệnh_Lấy_Rỗng_List:
        - **Bước 4.1: Bỏ qua trường hợp tự ghép với chính mình (nếu logic cho phép).**
        - **Bước 4.2: Áp dụng BỘ LỌC CỨNG (Hard Filters):**
            - IF dropOffOrder.container_type_id !== pickupOrder.container_type_id THEN continue; (Bỏ qua nếu khác loại cont).
            - *Thêm các bộ lọc cứng khác nếu có (ví dụ: không cho phép một số hãng tàu street-turn).*
        - **Bước 4.3: Gọi Hàm Tính Điểm (Scoring Function):**
            - Đây là "bộ não" mà chúng ta đã thiết kế (Hệ thống Tính Điểm V2.0).
            - Tạo một hàm riêng biệt, ví dụ: calculateMatchScore(dropOffOrder, pickupOrder).
            - Hàm này sẽ nhận vào 2 đối tượng và trả về một object chi tiết: { overallScore, scenarioType, scoreDetails, extraTasks, estimatedCosts }.
            - **Bên trong calculateMatchScore:**
                - Nó sẽ thực hiện tất cả các logic phân tích phức tạp:
                - Xác định loại kịch bản (Nội bộ, Marketplace, Khác HT...).
                - Kiểm tra điều kiện Địa điểm, Thời gian, Chất lượng.
                - Nếu có rào cản, nó sẽ xác định giải pháp (COD, Bãi ảo, VAS).
                - Dựa trên tất cả các yếu tố trên, nó tính toán các điểm thành phần và điểm tổng kết theo công thức V2.0.
                - Nó đóng gói các tác vụ và chi phí phát sinh vào mảng extraTasks và estimatedCosts.
        - **Bước 4.4: Thêm Cơ hội vào Nhóm:**
            - Lấy kết quả từ calculateMatchScore.
            - IF result.overallScore > NGƯỠNG_ĐIỂM_TỐI_THIỂU (ví dụ: 20) THEN: (Để loại bỏ các gợi ý quá tệ).
                - Tạo một đối tượng opportunity:Generated javascript
                    
                    `let opportunity = {
                      pickupOrder: pickupOrder,
                      ...result // Chứa overallScore, scenarioType, etc.
                    };`
                    
                - suggestionGroup.matchingOpportunities.push(opportunity);
5. **Sắp xếp & Hoàn thiện:**
    - // Sau khi vòng lặp phụ kết thúc
    - **Sắp xếp các cơ hội:** suggestionGroup.matchingOpportunities.sort((a, b) => b.overallScore - a.overallScore); (Sắp xếp theo điểm từ cao đến thấp).
    - **Thêm nhóm vào kết quả cuối cùng:** IF suggestionGroup.matchingOpportunities.length > 0 THEN results.push(suggestionGroup);
6. **Trả về Kết quả:**
    - RETURN results;

### **Phần 3: Logic Cập nhật Trạng thái (Phía Client/Server Action)**

- **Trigger:** Khi người dùng chọn một "cơ hội" và nhấn "Tạo Yêu cầu".
- **Hành động:**
    1. Server Action được gọi với dropOffOrderId và pickupOrderId đã chọn.
    2. Server Action thực hiện việc tạo yêu cầu như đã định nghĩa.
    3. **Quan trọng:** Sau khi thành công, nó sẽ gọi revalidatePath('/dispatcher-dashboard').
- **Kết quả:** Khi trang dashboard được render lại:
    - Thuật toán generateMatchingSuggestions sẽ chạy lại.
    - Lệnh Lấy Rỗng đã được chọn giờ đây có status không phải là AVAILABLE.
    - Do đó, ở **Bước 4.2 (Bộ lọc cứng)**, nó sẽ tự động bị loại bỏ và không còn xuất hiện trong bất kỳ danh sách gợi ý nào nữa. Điều này đảm bảo mỗi LLR chỉ được ghép nối một lần tại một thời điểm.

---

**Next Step (Bước Tiếp theo):**

1. **Refactor Backend:** Tập trung vào việc xây dựng hàm calculateMatchScore mạnh mẽ và hàm chính generateMatchingSuggestions. Đây là phần lõi của thay đổi này.
2. **Tạo API hoặc Server Component:** Xây dựng một endpoint hoặc Server Component trên trang Dashboard để gọi hàm generateMatchingSuggestions và lấy về cấu trúc dữ liệu JSON đã được định hình.
3. **Thiết kế Giao diện Mới:** Sau khi có dữ liệu, bắt tay vào việc xây dựng giao diện hiển thị dạng "1-nhiều" như bạn đã mô tả, với các thẻ Lệnh Giao Trả và danh sách các cơ hội Lệnh Lấy Rỗng con bên trong, có thể mở rộng/thu gọn.

## Giao Diện Gợi Ý Ghép Nối 1-Nhiều ##

### **Mô Tả Chi Tiết Coding: Giao Diện Gợi Ý Ghép Nối 1-Nhiều**

**Mục tiêu tổng thể:** Xây dựng một giao diện phân cấp, rõ ràng, nơi mỗi "Lệnh Giao Trả" (LGT) được xem là một nhóm, và bên trong là danh sách các "Lệnh Lấy Rỗng" (LLR) tiềm năng có thể ghép cặp, được sắp xếp theo điểm số hiệu quả.

**Cấu trúc Component đề xuất:**

Generated code

`<SuggestionsContainer> // Component chính, nhận dữ liệu và render các nhóm
  <DropOffOrderGroup>   // Mỗi nhóm là một LGT
    <Header>          // Hiển thị thông tin LGT
    <OpportunitiesList> // Danh sách các cơ hội ghép nối
      <OpportunityRow>  // Mỗi hàng là một LLR có thể ghép cặp
        <ScoreBadge />  // Hiển thị điểm số
        <Info />        // Thông tin tóm tắt của LLR
        <DetailsAccordion /> // Phần chi tiết có thể mở rộng
      </OpportunityRow>
    </OpportunitiesList>
  </DropOffOrderGroup>
</SuggestionsContainer>`

---

### **Mô Tả Chi Tiết Cho Từng Component**

### **1. Component Chính: SuggestionsContainer.tsx**

- **File:** src/components/features/dispatcher/suggestions/SuggestionsContainer.tsx
- **Mục tiêu:** Nhận mảng dữ liệu đã được xử lý từ server và lặp để render ra từng nhóm gợi ý.
- **Props:**
    - suggestionGroups: SuggestionGroupType[] (Đây là cấu trúc JSON 1-nhiều mà backend trả về).
- **Yêu cầu (Code):**Generated tsx
    
    `import { DropOffOrderGroup } from './DropOffOrderGroup';
    import { SuggestionGroupType } from '@/lib/types'; // Đảm bảo bạn có type này
    
    interface SuggestionsContainerProps {
      suggestionGroups: SuggestionGroupType[];
    }
    
    export function SuggestionsContainer({ suggestionGroups }: SuggestionsContainerProps) {
      if (!suggestionGroups || suggestionGroups.length === 0) {
        return <p>Không có gợi ý nào phù hợp.</p>; // Trạng thái rỗng
      }
    
      return (
        <div className="space-y-6">
          {suggestionGroups.map((group) => (
            <DropOffOrderGroup key={group.dropOffOrder.id} group={group} />
          ))}
        </div>
      );
    }`
    

### **2. Component Nhóm: DropOffOrderGroup.tsx**

- **File:** src/components/features/dispatcher/suggestions/DropOffOrderGroup.tsx
- **Mục tiêu:** Hiển thị thông tin của một "Lệnh Giao Trả" và chứa danh sách các cơ hội ghép cặp của nó.
- **Props:**
    - group: SuggestionGroupType
- **Yêu cầu (Code):**Generated tsx
    - Sử dụng <Card> hoặc một div có bo góc và đổ bóng nhẹ làm khung.
    
    `import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
    import { OpportunityRow } from "./OpportunityRow";
    
    export function DropOffOrderGroup({ group }: { group: SuggestionGroupType }) {
      const { dropOffOrder, matchingOpportunities } = group;
    
      return (
        <Card>
          <CardHeader className="bg-neutral-light p-4 border-b">
            <CardTitle className="text-lg">
              <span className="font-bold">{dropOffOrder.containerNumber}</span>
              <span className="ml-2 text-text-secondary font-normal">| {dropOffOrder.containerType} | {dropOffOrder.shippingLiner}</span>
            </CardTitle>
            <p className="text-sm text-text-secondary">📍 Sẵn sàng tại: {dropOffOrder.location}</p>
          </CardHeader>
          <CardContent className="p-0">
            {/* Danh sách các cơ hội */}
            <div className="divide-y">
              {matchingOpportunities.map(opportunity => (
                <OpportunityRow key={opportunity.pickupOrder.id} opportunity={opportunity} dropOffOrder={dropOffOrder}/>
              ))}
            </div>
          </CardContent>
        </Card>
      );
    }`
    

### **3. Component Hàng Cơ hội: OpportunityRow.tsx**

- **File:** src/components/features/dispatcher/suggestions/OpportunityRow.tsx
- **Mục tiêu:** Hiển thị thông tin tóm tắt của một cặp ghép nối và các chi tiết khi được yêu cầu.
- **Props:**
    - opportunity: MatchingOpportunityType
    - dropOffOrder: DropOffOrderType (truyền xuống để action có đủ context)
- **Yêu cầu (Code):**Generated tsx
    - Đây là component phức tạp nhất, sử dụng <Accordion> để hiển thị chi tiết.
    
    `import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion";
    import { ScoreBadge } from "./ScoreBadge"; // Component con để hiển thị điểm
    import { Button } from "@/components/ui/button";
    
    export function OpportunityRow({ opportunity, dropOffOrder }: { ... }) {
      const { pickupOrder, overallScore, scenarioType, scoreDetails, extraTasks, estimatedCosts } = opportunity;
      
      // Hàm này sẽ gọi Server Action để tạo yêu cầu
      const handleCreateRequest = () => {
        // createStreetTurnRequest(dropOffOrder.id, pickupOrder.id);
      }
    
      return (
        <Accordion type="single" collapsible className="w-full">
          <AccordionItem value="item-1" className="border-b-0">
            {/* Phần luôn hiển thị */}
            <div className="flex items-center p-4">
              <ScoreBadge score={overallScore} />
              <div className="ml-4 flex-grow">
                <p className="font-semibold">Ghép với Lệnh: {pickupOrder.bookingNumber}</p>
                <p className="text-sm text-text-secondary">📍 Lấy tại: {pickupOrder.location}</p>
              </div>
              <AccordionTrigger className="px-2" />
            </div>
    
            {/* Phần chi tiết có thể mở rộng */}
            <AccordionContent className="px-4 pb-4 bg-gray-50">
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <h4 className="font-semibold mb-2">Phân Tích Điểm Số</h4>
                  <p>Khoảng cách: {scoreDetails.distance.toFixed(1)}/40</p>
                  <p>Thời gian: {scoreDetails.time.toFixed(1)}/20</p>
                  <p>Độ phức tạp: {scoreDetails.complexity}/15</p>
                  <p>Chất lượng & Uy tín: {scoreDetails.quality.toFixed(1)}/25</p>
                </div>
                <div>
                  <h4 className="font-semibold mb-2">Chi Tiết Kịch Bản</h4>
                  <p><b>Loại:</b> {scenarioType}</p>
                  {extraTasks.length > 0 && (
                    <div className="mt-2">
                      <p className="font-semibold">Tác vụ thêm:</p>
                      <ul className="list-disc list-inside">
                        {extraTasks.map(task => <li key={task}>{task}</li>)}
                      </ul>
                    </div>
                  )}
                  {estimatedCosts.length > 0 && (
                    <div className="mt-2">
                      <p className="font-semibold">Chi phí phát sinh:</p>
                      <ul className="list-disc list-inside">
                        {estimatedCosts.map(cost => <li key={cost.type}>{cost.type}: {cost.amount.toLocaleString()}đ</li>)}
                      </ul>
                    </div>
                  )}
                </div>
              </div>
              <div className="mt-4 text-right">
                <Button onClick={handleCreateRequest}>Tạo Yêu Cầu</Button>
              </div>
            </AccordionContent>
          </AccordionItem>
        </Accordion>
      );
    }`
    

### **4. Component Điểm Số: ScoreBadge.tsx**

- **File:** src/components/features/dispatcher/suggestions/ScoreBadge.tsx
- **Mục tiêu:** Hiển thị điểm số dưới dạng một vòng tròn có màu sắc tương ứng.
- **Props:** score: number
- **Yêu cầu (Code):**Generated tsx
    
    `export function ScoreBadge({ score }: { score: number }) {
      const getScoreColor = () => {
        if (score >= 75) return 'bg-green-100 text-green-800 border-green-300'; // Xanh lá
        if (score >= 50) return 'bg-yellow-100 text-yellow-800 border-yellow-300'; // Vàng
        return 'bg-red-100 text-red-800 border-red-300'; // Đỏ
      };
    
      return (
        <div className={`flex items-center justify-center w-16 h-16 rounded-full border-2 ${getScoreColor()}`}>
          <span className="text-2xl font-bold">{Math.round(score)}</span>
        </div>
      );
    }`
    

---

**Next Step (Bước Tiếp Theo):**

1. **Tạo các file component:** Bắt đầu tạo các file component như đã cấu trúc ở trên.
2. **Xây dựng từ trong ra ngoài:** Bắt đầu code component nhỏ nhất là ScoreBadge.tsx, sau đó đến OpportunityRow.tsx, và cuối cùng là DropOffOrderGroup.tsx và SuggestionsContainer.tsx.
3. **Tích hợp Logic:** Kết nối nút "Tạo Yêu Cầu" trong OpportunityRow.tsx với Server Action tương ứng.
4. **Hoàn thiện trang Dashboard:** Đặt component <SuggestionsContainer /> đã hoàn thiện vào trang Bảng Điều Phối của Dispatcher.