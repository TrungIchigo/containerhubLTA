### **Cập Nhật Tổng Quan Về Nghiệp Vụ i-ContainerHub@LTA**

**Thay đổi cốt lõi 1: Chức năng COD được kiểm soát chặt chẽ.**

- Việc đổi nơi trả rỗng (COD) không còn là một lựa chọn tự do nữa. Người dùng chỉ có thể yêu cầu đổi nơi trả đến các **depot thuộc sở hữu và quản lý của GPG**. Điều này biến COD từ một tính năng "mở" thành một dịch vụ "đóng" có kiểm soát, đảm bảo chất lượng và tạo ra giá trị trực tiếp cho GPG.

**Thay đổi cốt lõi 2: Tinh gọn các kịch bản Street-turn.**

- Loại bỏ các kịch bản "lai" và các dịch vụ vệ tinh phức tạp ở giai đoạn này. Chúng ta sẽ tập trung vào 4 kịch bản chính, rõ ràng và có khả năng xảy ra cao nhất.

---

### **Mô Tả Chi Tiết Các Kịch Bản & Luồng Nghiệp Vụ (Đã Cập nhật)**

### **A. Cập nhật Luồng Nghiệp Vụ COD (Thực hiện Trái tuyến)**

**Luồng mới:**

1. **[Dispatcher]** Khi tạo yêu cầu COD, form "Chọn Depot Mới Mong Muốn" sẽ chỉ hiển thị danh sách các depot được lấy từ bảng gpg_depots. **Không còn lựa chọn nhập địa chỉ tùy chỉnh hay chọn từ tất cả các depot khác.**
2. **[Hệ thống]** Chi phí COD cho việc đổi đến các depot GPG này sẽ được tra cứu từ một bảng giá nội bộ, đảm bảo tính nhất quán và chính sách giá của GPG.
3. Phần còn lại của luồng phê duyệt bởi LTA Admin và các bước thanh toán, cập nhật trạng thái vẫn giữ nguyên.

**Mô tả để AI cập nhật code:**

- **CSDL:** bảng mới gpg_depots trên Supabase có schema giống hệt bảng depots và đã có dữ liệu các depot thuộc GPG
- **Frontend (Form COD):** Thay đổi nguồn dữ liệu cho dropdown "Chọn Depot Mới" từ bảng depots sang bảng gpg_depots.
- **Backend (Bảng giá):** Cần có một bảng gpg_cod_fee_matrix mới để tra cứu chi phí khi đổi nơi trả giữa các depot GPG.

---

### **B. Mô Tả Các Kịch Bản Ghép Nối Street-turn (Đã Tinh gọn)**

- **Tình huống:** NVT tìm cách tối ưu hóa các lệnh của chính họ.
- **Case 1A: Cùng Hãng tàu**
    - **Mô tả:** Đây là kịch bản street-turn nội bộ lý tưởng. Hệ thống sẽ quét các LGT và LLR của cùng một NVT, cùng một hãng tàu, nếu thỏa mãn điều kiện thời gian, địa điểm, chất lượng -> Gợi ý ghép nối.
    - **Hành động:** Dispatcher tạo yêu cầu, LTA Admin duyệt.
- **Case 1B: Khác Hãng tàu**
    - **Mô tả:** Tình huống NVT có LGT của hãng A nhưng LLR lại cần cho booking của hãng B.
    - **Hành động:** Hệ thống vẫn sẽ gợi ý như một cơ hội "có điều kiện". Dispatcher sẽ được cung cấp công cụ "Điều chỉnh & Ghép nối" để tự thay đổi thông tin booking/hãng tàu trên LLR của mình, sau đó mới tạo yêu cầu street-turn để LTA Admin duyệt.
- **Tên kịch bản:** Giao dịch Marketplace Tại Depot.
- **Mô tả:** Đây là trường hợp **duy nhất** cho phép ghép nối chéo công ty **mà không cần COD**.
    - **Điều kiện bắt buộc:** Lệnh Giao Trả của NVT 1 và Lệnh Lấy Rỗng của NVT 2 phải có **cùng một Depot** được chỉ định (hoặc là nơi trả mặc định của LGT, hoặc là nơi lấy mặc định của LLR).
    - **Ví dụ:** NVT 1 có LGT trả về "ICD Sóng Thần". NVT 2 có LLR cần lấy tại chính "ICD Sóng Thần". Nếu các điều kiện khác khớp, hệ thống sẽ gợi ý giao dịch này.
- **Luồng hoạt động:**
    1. **[Hệ thống]:** Phát hiện cơ hội này và tạo một "Giao dịch Tiềm năng" cho LTA Admin.
    2. **[LTA Admin]:** Điều phối giao dịch, gửi đề nghị cho NVT 1 (thực hiện tái sử dụng thay vì trả vào depot) và thông báo cho NVT 2 (sẽ có xe khác giao cont đến cho họ). *Mô hình "Bán lệnh" có thể được áp dụng ở đây*.
- **Logic bị loại bỏ:** Sẽ không còn trường hợp ghép nối chéo công ty mà có khoảng cách gần nhưng khác depot nếu không thông qua COD.
- **Tên kịch bản:** Street-turn Nội bộ Kết hợp COD về Bãi GPG.
- **Mô tả:** Khi một cặp LGT và LLR của cùng một NVT bị **lệch về địa điểm**.
- **Luồng hoạt động:**
    1. **[Hệ thống]:** Phát hiện cơ hội này và đề xuất một kế hoạch kết hợp: "Đề xuất đổi nơi trả của LGT về **[một trong các Depot/Bãi của GPG]** để thực hiện street-turn."
    2. **[Dispatcher]:** Thấy gợi ý và tạo một "Yêu cầu Kết hợp".
    3. **[LTA Admin]:** Nhận và phê duyệt toàn bộ kế hoạch.
- **Tên kịch bản:** Street-turn Marketplace Kết hợp COD về Bãi GPG.
- **Mô tả:** Đây là kịch bản phức tạp nhất còn lại. LGT của NVT 1 và LLR của NVT 2 ở xa nhau.
- **Luồng hoạt động:**
    1. **[Hệ thống]:** Phát hiện cơ hội và tạo "Giao dịch Tiềm năng" cho LTA Admin.
    2. **[LTA Admin]:** Xem xét và bắt đầu điều phối: Gửi đề nghị cho NVT 1 chấp thuận kế hoạch (bao gồm cả việc COD về Bãi GPG và sau đó thực hiện giao dịch với một đối tác khác).
    3. Sau khi NVT 1 đồng ý, LTA Admin sẽ "khóa" giao dịch và điều phối các bước tiếp theo.

---

### **Thuật Toán Ghép Nối & Tính Điểm (Cần Cập Nhật)**

**Các logic cần loại bỏ hoặc điều chỉnh:**

- **Bãi Container Ảo, Dịch vụ Vệ sinh/Sửa chữa Lưu động:** Các khái niệm này sẽ được tạm thời loại bỏ khỏi thuật toán tính điểm và các luồng gợi ý tự động.
- **Ghép nối chéo công ty tự do:** Logic quét và gợi ý các cặp khác NVT có khoảng cách gần nhưng khác depot sẽ bị vô hiệu hóa. Ghép chéo chỉ xảy ra khi cùng depot hoặc thông qua một yêu cầu COD do LTA Admin điều phối.

**Mô tả để AI cập nhật code:**

- **Mục tiêu:** Tinh gọn hàm calculateMatchScore và generateMatchingSuggestions.
- **Hành động:**
    1. **Refactor calculateMatchScore:** Xóa bỏ các case và điểm thưởng/phạt liên quan đến "Lưu trữ tại bãi ảo" và "Dịch vụ VAS". Giữ lại logic tính điểm cho khoảng cách, thời gian, độ phức tạp giao dịch (Nội bộ, Marketplace, COD) và uy tín đối tác.
    2. **Refactor generateMatchingSuggestions:**
        - Thêm một điều kiện lọc cứng trong logic Marketplace: ... AND dropoff_order.depot_id === pickup_order.depot_id.
        - Chỉ khi điều kiện trên không thỏa mãn, thuật toán mới chuyển sang quét các kịch bản có yêu cầu COD.