---

### **Phân Tích & Phản Hồi Từ Góc Nhìn Nghiệp Vụ (Đã cập nhật)**

- **Về Điểm Bắt Đầu Luồng:** Trang **"Thanh Toán & Hóa Đơn"** (Hình 1) mà bạn đã thiết kế là một trung tâm thanh toán **xuất sắc** và trực quan hơn rất nhiều so với việc phải thao tác từ menu 3 chấm. Đây nên là điểm khởi đầu chính cho mọi hoạt động thanh toán. Các khoản phí COD sau khi duyệt nên được liệt kê ngay trong mục **"Giao Dịch Chờ Xuất Hóa Đơn"**.
- **Về Màn Hình Nạp Quỹ:** Màn hình tham khảo (Hình 2) rất rõ ràng, hiện đại và thân thiện với người dùng. Chúng ta sẽ áp dụng triệt để layout và logic này cho phiên bản web.
- **Về Luồng Ngoại Lệ (Hết hạn):** Tôi vẫn giữ đề xuất về trạng thái **OVERDUE_PAYMENT** (Quá hạn thanh toán) thay vì hủy ngay sau 4 tiếng, vì nó thực tế hơn cho môi trường B2B.

---

### **Mô Tả Chi Tiết Để AI Code: Luồng Thanh Toán Phí COD (Phiên bản Hoàn Chỉnh)**

### **Hạng Mục 1: Khởi Tạo Luồng Từ Trung Tâm Thanh Toán**

**Task 1.1: Cập nhật Trang "Thanh Toán & Hóa Đơn"**

- **File:** Trang Thanh Toán (/dispatcher/billing).
- **Mục tiêu:** Biến các dòng giao dịch đang chờ thành các hành động có thể thực hiện.
- **Yêu cầu:**
    1. **Logic Backend:** Server Action handleCodDecision, sau khi phê duyệt một yêu cầu COD có phí, sẽ INSERT một record vào bảng transactions với status = 'UNPAID' (chờ xuất hóa đơn) hoặc PENDING_PAYMENT (chờ thanh toán ngay). **Để linh hoạt, chúng ta sẽ dùng trạng thái PENDING_PAYMENT**.
    2. **Giao diện:**
        - Khu vực **"Giao Dịch Chờ Thanh Toán"** (thay vì "Chờ Xuất Hóa Đơn") sẽ hiển thị tất cả các giao dịch có trạng thái PENDING_PAYMENT.
        - Mỗi dòng giao dịch sẽ có các cột: Loại phí (ví dụ: "Phí COD"), Mô tả, Số tiền.
        - **Cột cuối cùng "Hành động"** sẽ có một nút <Button variant="primary">Thanh toán</Button> nổi bật.
        - Khi nhấp vào nút "Thanh toán", **Dialog CodPaymentDialog.tsx** sẽ được mở ra.

### **Hạng Mục 2: Xây Dựng Dialog Thanh Toán Chi Tiết (CodPaymentDialog.tsx)**

- **File cần tạo/cập nhật:** src/components/features/billing/CodPaymentDialog.tsx.
- **Yêu cầu:** Thiết kế Dialog này dựa trên các màn hình tham khảo.
    1. **Layout:** Dialog lớn (sm:max-w-4xl), 2 cột.
    2. **Cột Trái - Tóm Tắt Thông Tin:** (Tương tự như cũ) Tiêu đề, Số container, Tuyến đường, **Tổng số tiền cần thanh toán**.
    3. **Cột Phải - Lựa Chọn Phương Thức:**
        - Sử dụng <Tabs> với defaultValue="qr_code".
        - Tạo 2 <TabsTrigger>: **"Chuyển khoản VietQR"** và **"Quỹ i-Prepaid@LTA"**.

### **Hạng Mục 3: Luồng Thanh Toán & Nạp Tiền Bằng Quỹ (Áp dụng thiết kế mới)**

- **File:** Bên trong CodPaymentDialog.tsx.
- **Yêu cầu (trong <TabsContent value="prepaid_fund">):**
    1. **Hiển thị Logo & Tên Quỹ:** Ở trên cùng của tab này, hiển thị logo **"OneStop@LTA"** (Hình 3) và tên "Thanh toán bằng Quỹ i-Prepaid".
    2. **Hiển thị Số dư:** "Số dư khả dụng: [Số dư]".
    3. **Nút Thanh toán & Logic:** Nút "Thanh toán [Số tiền]" vẫn được kích hoạt. Khi nhấn, nếu số dư không đủ, một Alert Dialog sẽ hiện ra hỏi người dùng có muốn **"Nạp tiền ngay"** không.
    4. **Dialog Nạp Tiền (TopUpDialog.tsx):**
        - **Mục tiêu:** Tái tạo lại giao diện từ Hình 2 trên web.
        - **Layout:**
            - Header: Logo **"OneStop@LTA"** và tiêu đề "Nạp Quỹ".
            - Khu vực hiển thị: "Số dư hiện tại" và "Mã quỹ" của Khách hàng.
            - Khu vực nhập liệu: Tiêu đề "Số tiền cần nạp". Một lưới các <Button variant="outline"> với các mệnh giá có sẵn (1.000.000đ, 500.000đ...). Một ô <Input> cho phép nhập số tiền tùy chỉnh.
            - Footer: Nút **"<Button>Nạp tiền</Button>"**.
        - **Luồng hoạt động:**
            
            a. Người dùng chọn/nhập số tiền và nhấn "Nạp tiền".
            
            b. Dialog chuyển sang bước 2: Hiển thị một **mã VietQR** đã được tạo với chính xác số tiền và nội dung "NAP QUY [Mã quỹ]".
            
            c. Người dùng quét mã và chuyển khoản. Sau đó, họ nhấn nút "Tôi đã hoàn tất chuyển khoản".
            
            d. Hệ thống hiển thị thông báo: "Giao dịch đang được xử lý. Số dư sẽ được cập nhật sau khi LTA xác nhận."
            
            e. Dialog đóng lại, quay về màn hình thanh toán COD. Người dùng có thể cần chờ hoặc tải lại trang để thấy số dư mới.
            

### **Hạng Mục 4: Cập Nhật Trạng Thái & Luồng Ngoại Lệ**

1. **CSDL & Trạng thái:**
    - **cod_requests status:** PENDING -> APPROVED -> PENDING_PAYMENT -> PAID -> PROCESSING_AT_DEPOT -> COMPLETED.
    - **import_containers status:** AVAILABLE -> AWAITING_COD_APPROVAL -> APPROVED_COD -> ON_GOING_COD -> COMPLETED.
    - Các trạng thái ngoại lệ: OVERDUE_PAYMENT, PAYMENT_CANCELLED, EXPIRED.
2. **Server Action processCodPayment(requestId):**
    - Được gọi khi thanh toán bằng quỹ thành công hoặc khi LTA Admin xác nhận thanh toán qua chuyển khoản.
    - Logic:
        - UPDATE cod_requests SET status = 'PAID'.
        - UPDATE transactions SET status = 'PAID'.
        - UPDATE import_containers SET status = 'ON_GOING_COD'.
3. **Cron Job xử lý Quá hạn Thanh toán:**
    - Tác vụ nền chạy định kỳ.
    - Tìm các yêu cầu COD có status = 'APPROVED' và đã quá 4 tiếng.
    - Đổi trạng thái của Yêu cầu COD và Lệnh Giao Trả liên quan thành OVERDUE_PAYMENT. Gửi thông báo nhắc nợ.

Bản cập nhật này đã tích hợp đầy đủ các yếu tố thiết kế từ hình ảnh bạn cung cấp, tạo ra một luồng thanh toán chuyên nghiệp, trực quan và liền mạch từ Trung tâm Thanh toán cho đến khi giao dịch hoàn tất.