### **Phần 1: Phân Tích & Phản Biện Từ Góc Nhìn Nghiệp Vụ**

Trước khi đi vào thiết kế chi tiết, đây là một vài phản hồi và đề xuất của tôi với tư cách người dùng:

- **Về việc kích hoạt luồng thanh toán:**
    - **Phản hồi:** Yêu cầu tôi phải vào "Danh sách chi tiết" -> tìm đúng lệnh -> nhấn menu 3 chấm -> rồi mới nhấn "Thanh toán" là hơi nhiều bước và dễ bị bỏ sót, đặc biệt khi tôi có nhiều lệnh COD cần thanh toán.
    - **Đề xuất:** Ngoài luồng hiện tại, nên có một **Trung tâm Thanh toán (Billing Center)** tập trung. Trong Sidebar, nên có một mục "Thanh toán & Công nợ". Khi tôi vào đó, tôi sẽ thấy một danh sách của **TẤT CẢ** các khoản phí đang chờ thanh toán (cả COD, Marketplace...), tôi có thể chọn thanh toán nhiều khoản cùng lúc. Tuy nhiên, với MVP, việc thanh toán từng lệnh như bạn mô tả là một điểm khởi đầu hợp lý, chúng ta sẽ làm nó thật tốt trước.
- **Về luồng thanh toán bằng Quỹ:**
    - **Phản hồi:** Luồng này rất hay, nhưng hành trình "không đủ tiền -> phải nạp tiền -> quay lại" có thể hơi dài.
    - **Đề xuất:** Trên màn hình thanh toán bằng Quỹ, ngay cả khi không đủ tiền, nút **"Thanh toán"** vẫn nên được kích hoạt. Khi tôi nhấn vào, một Popup sẽ hiện ra báo: "Số dư không đủ. Bạn cần nạp thêm [số tiền còn thiếu] để hoàn tất giao dịch này." Sau đó mới có 2 nút: "Nạp tiền ngay" và "Hủy". Điều này giúp tôi biết chính xác số tiền cần nạp cho chỉ giao dịch này, thay vì phải tự tính toán.
- **Về luồng ngoại lệ:**
    - **Phản hồi:** Việc yêu cầu hết hạn sau 4 tiếng và phải gửi duyệt lại là một quy tắc hơi khắc nghiệt và có thể gây phiền toái. Trong thực tế, có thể Kế toán nghỉ trưa hoặc bận họp đột xuất.
    - **Đề xuất:** Thay vì hủy hoàn toàn, yêu cầu nên chuyển sang trạng thái **OVERDUE_PAYMENT (Quá hạn thanh toán)**. Trạng thái này sẽ khóa lệnh lại và gửi thông báo nhắc nhở dồn dập hơn cho cả Dispatcher và người quản lý. Lệnh chỉ thực sự bị hủy (Expired) sau một thời gian dài hơn, ví dụ 24 giờ. Điều này mang tính thực tế và linh hoạt hơn cho người dùng.

---

### **Phần 2: Mô Tả Chi Tiết Để AI Code (Dựa trên Phản hồi & Đề xuất)**

### **Hạng Mục 1: Khởi Tạo Luồng & Màn Hình Thanh Toán Chi Tiết**

**Task 1.1: Cập Nhật Trang Danh Sách & Thêm Nút Thanh Toán**

- **File:** Trang "Quản lý Yêu cầu" -> Tab "Yêu cầu Đổi Nơi Trả" (/dispatcher/requests).
- **Yêu cầu:**
    - Với các yêu cầu COD có trạng thái Đã duyệt (APPROVED), trong cột "Hành động", hiển thị một nút **<Button variant="primary">Thanh toán ngay</Button>** nổi bật.
    - Khi nhấp vào nút này, hệ thống sẽ mở ra một **Dialog/Modal** lớn chứa toàn bộ quy trình thanh toán.

**Task 1.2: Thiết Kế Màn Hình Thanh Toán Chi Tiết (CodPaymentDialog.tsx)**

- **File cần tạo:** src/components/features/cod/CodPaymentDialog.tsx.
- **Yêu cầu:**
    1. **Layout:** Dialog lớn (ví dụ sm:max-w-4xl), chia thành 2 cột: Cột trái (Thông tin Đơn hàng) và Cột phải (Lựa chọn Thanh toán).
    2. **Cột Trái - Tóm Tắt Thông Tin:**
        - Tiêu đề: "Thanh toán phí COD".
        - Hiển thị rõ các thông tin:
            - Số Container.
            - Tuyến đường thay đổi: Từ [Depot Gốc] → Đến [Depot Mới].
            - **Tổng số tiền cần thanh toán:** Hiển thị lớn, rõ ràng (ví dụ: 902.000 đ).
    3. **Cột Phải - Lựa Chọn Phương Thức:**
        - Sử dụng component <Tabs> của Shadcn/ui với defaultValue là "qr_code".
        - Tạo 2 <TabsTrigger>: **"Chuyển khoản VietQR"** và **"Thanh toán bằng Quỹ i-Prepaid"**.
        - Bên dưới sẽ là 2 <TabsContent> tương ứng.

### **Hạng Mục 2: Luồng Thanh Toán Bằng VietQR**

- **File:** Bên trong CodPaymentDialog.tsx.
- **Yêu cầu (trong <TabsContent value="qr_code">):**
    1. **Hiển thị Mã QR:**
        - Tích hợp một thư viện tạo mã QR (ví dụ: qrcode.react).
        - Mã QR này phải được tạo theo **tiêu chuẩn của VietQR**, chứa thông tin về Ngân hàng, Số tài khoản, **Số tiền chính xác** và **Nội dung chuyển khoản** (ví dụ: PAY COD [mã yêu cầu]). Việc này giúp cho việc đối soát tự động sau này cực kỳ dễ dàng.
    2. **Hiển thị Thông tin Chuyển khoản (Dạng text để copy):**
        - Tên ngân hàng.
        - Chủ tài khoản: CONG TY CO PHAN LOGISTICS TECHNOLOGY APPLICATION
        - Số tài khoản.
        - Số tiền.
        - **Nội dung chuyển khoản:** PAY COD [mã yêu cầu] (Có nút "Sao chép" bên cạnh).
    3. **Lời kêu gọi & Hướng dẫn:**
        - "Quét mã để thanh toán nhanh chóng qua ứng dụng ngân hàng của bạn."
        - "Lưu ý: Vui lòng giữ nguyên nội dung chuyển khoản để giao dịch được xác nhận tự động."
    4. Nút ở dưới cùng: **"Tôi đã thanh toán"**. -> *Đây là một nút để người dùng xác nhận thủ công, trong tương lai có thể tích hợp webhook từ ngân hàng để tự động xác nhận.*

### **Hạng Mục 3: Luồng Thanh Toán & Nạp Tiền Bằng Quỹ i-Prepaid**

- **File:** Bên trong CodPaymentDialog.tsx.
- **Yêu cầu (trong <TabsContent value="prepaid_fund">):**
    1. **Hiển thị Số dư:**
        - Một dòng text lớn: "Số dư khả dụng: [Số dư hiện tại của quỹ]". (Dữ liệu này cần được fetch).
    2. **Hiển thị Số tiền Giao dịch.**
    3. **Nút Thanh toán:** Một <Button> lớn "Thanh toán 902.000 đ".
    4. **Logic của Nút Thanh toán:**
        - Gắn một hàm handlePayWithFund vào sự kiện onClick.
        - **Bên trong hàm:**
            - So sánh số dư với số tiền cần thanh toán.
            - **Nếu đủ tiền:** Gọi Server Action processCodPayment(requestId). Nếu thành công -> hiển thị Toast thành công, đóng Dialog sau 3s, và router.refresh().
            - **Nếu không đủ tiền (theo đề xuất cải tiến):**
                - Mở một <AlertDialog> nhỏ báo: "Số dư không đủ. Bạn cần nạp thêm [số tiền thiếu] để hoàn tất giao dịch."
                - Trong Alert, có 2 nút: **"Nạp tiền ngay"** (sẽ mở ra Dialog Nạp tiền) và **"Để sau"**.
    5. **Dialog/Component Nạp tiền (TopUpDialog.tsx):**
        - Giao diện gồm các nút chọn mốc nạp tiền sẵn (500k, 1M, 2M) và một ô input để nhập số tiền tùy chỉnh.
        - Khi số tiền được xác định, hiển thị một **mã VietQR** tương ứng (chứa đúng số tiền và nội dung "NAP TIEN [mã công ty]").
        - Sau khi người dùng quét và chuyển khoản, họ sẽ nhấn "Tôi đã nạp tiền". Hệ thống sẽ kiểm tra (hoặc họ phải chờ admin xác nhận) và cập nhật số dư.

### **Hạng Mục 4: Cập Nhật CSDL & Logic Trạng Thái (Luồng Ngoại Lệ)**

1. **Cập nhật ENUMs & Bảng:**
    - **cod_request_status:** Thêm các giá trị PENDING_PAYMENT, PAID, PROCESSING_AT_DEPOT, COMPLETED, OVERDUE_PAYMENT, PAYMENT_CANCELLED.
    - **asset_status:** (Trạng thái Lệnh Giao Trả) Thêm ON_GOING_COD, EXPIRED.
2. **Server Action markAsDelivered (mới):** Được gọi khi Dispatcher nhấn "Xác nhận đã giao trả". Sẽ đổi status yêu cầu COD thành PENDING_PAYMENT.
3. **Cron Job để Xử lý Hết hạn:**
    - Tạo một tác vụ nền chạy mỗi 15 phút.
    - **Logic:**
        - SELECT các yêu cầu COD có status = 'APPROVED' và updated_at < NOW() - INTERVAL '4 hours'.
        - UPDATE trạng thái của các yêu cầu này và Lệnh Giao Trả liên quan thành OVERDUE_PAYMENT (theo đề xuất cải tiến).
        - Gửi thông báo cho người dùng.
4. **Luồng Hủy thanh toán:**
    - Thêm một nút "Hủy" trên màn hình thanh toán.
    - Khi nhấn, một Server Action được gọi để đổi trạng thái Yêu cầu COD thành CANCELLED và rollback Lệnh Giao Trả về AVAILABLE.