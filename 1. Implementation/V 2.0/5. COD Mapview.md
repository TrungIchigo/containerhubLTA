---

### **Mô Tả Chi Tiết: Nâng Cấp Chức năng Yêu cầu COD - Giao diện Bản đồ**

**ID Chức năng:** `FEAT-COD-MAPVIEW-001`

**Tên Chức năng:** Tạo Yêu cầu Thay đổi Nơi Tr Giao trả (COD) qua Giao diện Bản đồ Tương tác.

**Mục tiêu (Business Goal):**
*   Cung cấp cho người dùng một công cụ trực quan hóa mạnh mẽ để so sánh và lựa chọn depot trả hàng mới tối ưu nhất.
*   Tăng tốc độ ra quyết định bằng cách hiển thị đồng thời thông tin về vị trí, lộ trình và chi phí.
*   Củng cố vị thế của i-ContainerHub như một nền tảng công nghệ logistics hiện đại, tập trung vào trải nghiệm người dùng.

---

#### **Phần 1: Luồng Nghiệp Vụ & Trải Nghiệm Người Dùng (UX Flow)**

1.  **[Dispatcher] Khởi tạo luồng (Không đổi):**
    *   Trên trang danh sách Lệnh Giao Trả, Dispatcher tìm đến một lệnh, nhấn vào **"Yêu cầu COD"**.
2.  **[Hệ thống] Hiển thị Giao diện COD Mới:**
    *   Thay vì một Dialog nhỏ, hệ thống sẽ điều hướng đến một **trang chuyên dụng** (ví dụ: `/dispatcher/cod/new-request?orderId=...`).
3.  **Bố cục Màn hình (Layout 3 khu vực):**
    *   **Khu vực chính (70%): Bản đồ Tương tác (Map View)**.
    *   **Khu vực Phụ (30%): Bảng So sánh & Chi tiết (Info & Comparison Panel)** ở bên trái.
    *   **Khu vực Dưới cùng: Tóm tắt & Hành động (Summary & Action Bar)**.
4.  **Tương tác trên Bản đồ:**
    *   **Hiển thị ban đầu:** Bản đồ sẽ tự động zoom và căn giữa, sao cho **Depot gốc** (Origin Depot) và các **Depot GPG** (Destination Depots) lân cận đều nằm trong tầm nhìn.
    *   **Các Điểm ghim (Markers):**
        *   **Depot gốc:** Có một icon đặc biệt, màu khác (ví dụ: màu xanh dương, icon phù hợp cần nổi bật được ý nghĩa của object).
        *   **Các Depot GPG:** Có các icon định vị tiêu chuẩn, có thể có logo GPG tôi sẽ gửi link hình ảnh kèm sau.
    *   **Hành động của người dùng (Click):** Khi Dispatcher nhấp vào một ghim Depot GPG trên bản đồ:
        *   **[Animation]:** Một đường nối màu xanh (polyline) sẽ được vẽ trên bản đồ, thể hiện lộ trình ước tính từ Depot gốc đến Depot GPG vừa được chọn.
        *   **[Cập nhật Dữ liệu]:** Bảng So sánh bên phải sẽ được cập nhật thông tin tương ứng.
5.  **Tương tác trên Bảng So sánh:**
    *   Bảng này liệt kê các Depot GPG lân cận, được sắp xếp mặc định theo **chi phí COD thấp nhất**.
    *   Mỗi hàng hiển thị: **Tên Depot**, **Khoảng cách (km)**, và **Phí COD (VNĐ)**.
    *   **Hành động của người dùng (Hover & Click):**
        *   Khi di chuột qua một hàng trong bảng, ghim tương ứng trên bản đồ sẽ **nảy lên (bounce)** hoặc phóng to để thu hút sự chú ý.
        *   Khi nhấp vào một hàng, hiệu ứng tương tự như nhấp trên bản đồ sẽ diễn ra (vẽ đường, cập nhật chi tiết).
6.  **Xác nhận và Gửi Yêu cầu:**
    *   Sau khi chọn được một depot ưng ý, Khu vực Dưới cùng (Summary Bar) sẽ hiển thị thông tin tóm tắt: "Bạn đã chọn đổi nơi trả về [Tên Depot Mới]. Phí COD: [số tiền]."
    *   Dispatcher nhấn nút **"Tiếp tục"** hoặc **"Gửi Yêu cầu"**.
    *   Luồng xác nhận cuối cùng (như Hình 7) sẽ hiện ra trước khi yêu cầu được gửi đi.

---

#### **Phần 2: Mô Tả Kỹ Thuật Chi Tiết Để AI Code**

**Hạng Mục 1: Cấu trúc Giao diện & Fetch Dữ liệu**

*   **File cần tạo/cập nhật:** Trang mới `src/app/(main)/dispatcher/cod/new/page.tsx` (sử dụng query `?orderId=...`).
*   **Yêu cầu (Trong Server Component của trang):**
    1.  Lấy `orderId` từ `searchParams`.
    2.  **Fetch song song (`Promise.all`):**
        *   Fetch chi tiết của "Lệnh Giao Trả" gốc (`originalOrder`).
        *   Fetch danh sách **TẤT CẢ** các depot thuộc GPG từ bảng `gpg_depots`.
        *   Fetch **ma trận phí COD của GPG** từ bảng `gpg_cod_fee_matrix`.

**Hạng Mục 2: Component Bản đồ Tương tác (`CodMap.tsx`)**

*   **File:** `src/components/features/cod/CodMap.tsx`.
*   **Yêu cầu (`'use client'`):**
    1.  **Thư viện:** Tích hợp `react-leaflet` và một thư viện để vẽ lộ trình như `leaflet-routing-machine` hoặc gọi API của Google Maps Directions.
    2.  **Props:** Nhận vào `originalOrder`, danh sách `gpgDepots`, và `selectedDepotId`. Đồng thời, cần một hàm callback `onDepotSelect` để thông báo cho component cha khi có depot được chọn.
    3.  **Logic `useEffect` để tính toán View ban đầu:**
        *   Khi component mount, dùng thư viện `@turf/turf` để tính toán một "khung chứa" (bounding box) bao gồm Depot gốc và các Depot GPG gần nhất.
        *   Sử dụng `map.fitBounds()` của Leaflet để tự động zoom bản đồ vào đúng khu vực này.
    4.  **Render Markers:** Lặp qua `gpgDepots` để render các `<Marker>`.
        *   Gắn sự kiện `onClick` cho mỗi Marker để gọi `onDepotSelect(depot.id)`.
    5.  **Vẽ Lộ trình:**
        *   Sử dụng một `useEffect` khác lắng nghe sự thay đổi của `selectedDepotId`.
        *   Khi `selectedDepotId` thay đổi, xóa bỏ lộ trình cũ và tạo một control routing mới của `leaflet-routing-machine`, nối tọa độ của `originalDepot` và `selectedDepot`.

**Hạng Mục 3: Component Bảng So sánh (`ComparisonTable.tsx`)**

*   **File:** `src/components/features/cod/ComparisonTable.tsx`.
*   **Yêu cầu (`'use client'`):**
    1.  **Props:** Nhận vào `originalDepotId`, danh sách `gpgDepots`, `codFeeMatrix`, `selectedDepotId`, và hàm callback `onDepotSelect`, `onDepotHover`.
    2.  **Logic Tính toán & Sắp xếp:**
        *   Khi component mount, nó sẽ dùng `codFeeMatrix` để tạo ra một danh sách các lựa chọn đã được tính toán sẵn.
        *   Sắp xếp danh sách này theo `fee` tăng dần.
    3.  **Render Bảng:**
        *   Lặp qua danh sách đã sắp xếp để render các hàng.
        *   Mỗi hàng có sự kiện `onClick={() => onDepotSelect(depot.id)}` và `onMouseEnter={() => onDepotHover(depot.id)}`.
        *   Áp dụng class CSS để highlight hàng được chọn (`selectedDepotId`).

**Hạng Mục 4: Component Trang Chính (`NewCodRequestPage.tsx`)**

*   **Mục tiêu:** Đóng vai trò là "nhạc trưởng", kết nối State và các Component con với nhau.
*   **Yêu cầu (`'use client'` - Bọc ngoài các component client):**
    1.  Sử dụng **Zustand** hoặc `useState` để quản lý các state chung:
        *   `selectedDepotId: string | null`
        *   `hoveredDepotId: string | null`
    2.  **Render Layout:**
        *   Render component `<CodMap>` và truyền state + các hàm setter vào.
        *   Render component `<ComparisonTable>` và truyền state + các hàm setter vào.
        *   Render Khu vực Tóm tắt Dưới cùng, hiển thị thông tin dựa trên `selectedDepotId` và chứa nút "Gửi Yêu cầu".

---

#### **Hạng Mục 5: Quản Lý State & Hành Động Cuối Cùng**

**Mục tiêu:** Xử lý hành động gửi yêu cầu của người dùng sau khi họ đã lựa chọn được depot mới, đồng thời quản lý các state phức tạp để đảm bảo giao diện phản hồi chính xác.

**Task 5.1: Xây Dựng Component Thanh Tóm Tắt & Hành Động (`ActionSummaryBar.tsx`)**

*   **File cần tạo:** `src/components/features/cod/ActionSummaryBar.tsx`.
*   **Yêu cầu (`'use client'`):**
    1.  **Props:** Nhận vào `originalOrder`, `selectedDepot` (object đầy đủ của depot được chọn), và `codFee`.
    2.  **Logic Hiển thị Động:**
        *   Component này sẽ lắng nghe `selectedDepotId` từ state chung.
        *   **Khi `selectedDepotId` là `null`:** Hiển thị một dòng text hướng dẫn, ví dụ: "Vui lòng chọn một depot mới trên bản đồ hoặc từ danh sách để xem chi tiết." và nút "Tiếp tục" sẽ bị **vô hiệu hóa (`disabled`)**.
        *   **Khi `selectedDepotId` có giá trị:**
            *   Hiển thị thông tin tóm tắt:
                > **"Bạn đã chọn đổi nơi trả về:** `[Tên Depot Mới]` **| Phí COD:** `[Phí]`"
            *   Nút "Tiếp tục" sẽ được **kích hoạt**.
    3.  **Tích hợp Dialog Xác nhận:**
        *   Nút "Tiếp tục" không gọi thẳng Server Action. Thay vào đó, nó sẽ là `<DialogTrigger>` để mở **Dialog Xác nhận Cuối cùng (`ConfirmationDialog.tsx`)**.

**Task 5.2: Tạo Dialog Xác Nhận Cuối Cùng (`ConfirmationDialog.tsx`)**

*   **File:** Dựa trên thiết kế ở Hình 7, component này sẽ được tái sử dụng và nâng cấp.
*   **Yêu cầu:**
    1.  **Props:** Nhận đầy đủ thông tin về giao dịch (lệnh gốc, depot mới, phí COD).
    2.  **Nội dung:** Hiển thị lại toàn bộ thông tin một cách rõ ràng để người dùng kiểm tra lần cuối:
        *   **Thông tin Container:** Số cont, loại cont.
        *   **Chi tiết Thay đổi:**
            *   **Từ (hiện tại):** Tên và địa chỉ Depot Gốc.
            *   **Đến (mong muốn):** Tên và địa chỉ Depot Mới.
        *   **Phí COD:** Hiển thị lại số tiền.
        *   **Khu vực Lưu ý quan trọng:** Giữ lại các lưu ý về thời hạn xử lý, trạng thái container... như bạn đã thiết kế.
    3.  **Hành động:** Nút "Hủy" và nút "Gửi Yêu Cầu". Nút "Gửi Yêu Cầu" sẽ thực sự gọi đến Server Action.

**Task 5.3: Cập Nhật Server Action `createCodRequest`**

*   **File:** `src/app/actions.ts` (hoặc `cod.actions.ts`).
*   **Yêu cầu:** Đảm bảo Action này có thể nhận và xử lý đầy đủ dữ liệu từ luồng mới.
*   **Đầu vào của Action:** `dropoffOrderId: string`, `requestedDepotId: string`.
*   **Logic bên trong (Cập nhật):**
    1.  **Không cần tính phí lại:** Action này giờ sẽ **không** tự tính toán phí nữa. Nó sẽ tin tưởng vào phí đã được tính và hiển thị cho người dùng ở client. Nó chỉ cần truy vấn lại `gpg_cod_fee_matrix` để xác thực lại con số này cho mục đích bảo mật.
    2.  Các bước còn lại (tạo record `cod_requests`, cập nhật trạng thái `import_containers`, ghi log...) vẫn được giữ nguyên như luồng cũ.

**Sơ đồ Tương tác giữa các Component (Phía Client):**

```mermaid
graph TD
    subgraph NewCodRequestPage (Trang chính)
        A[State Chung (Zustand)];
        A -- Cung cấp state --> B[CodMap.tsx];
        A -- Cung cấp state --> C[ComparisonTable.tsx];
        A -- Cung cấp state --> D[ActionSummaryBar.tsx];

        B -- onDepotSelect() --> A;
        C -- onDepotSelect() --> A;
    end

    subgraph Luồng Hành Động
        D -- "Click Tiếp tục (khi đã chọn)" --> E[Mở ConfirmationDialog.tsx];
        E -- "Click Gửi Yêu Cầu" --> F(Gọi Server Action: createCodRequest);
    end

    F --> G[Cập nhật CSDL];
    G --> H[Redirect hoặc Revalidate];

    style A fill:#f9f,stroke:#333,stroke-width:2px
```
