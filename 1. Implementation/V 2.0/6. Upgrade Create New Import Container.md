### **Ph√¢n T√≠ch Chi Ti·∫øt K·ªãch B·∫£n N√¢ng C·∫•p: T·∫°o L·ªánh Gh√©p N·ªëi H√†ng Lo·∫°t**

**1. T√™n k·ªãch b·∫£n**

- T·∫°o L·ªánh Giao Tr·∫£ H√†ng Lo·∫°t v√† Gh√©p N·ªëi T·ª©c Th√¨ (Bulk Drop-off Order Creation with Instant Pairing)

**2. ID k·ªãch b·∫£n**

- FEAT-BULK-ORDER-001

**3. M·ª•c ti√™u (Business Goal)**

- **AC1:** TƒÉng t·ªëc ƒë·ªô nh·∫≠p li·ªáu cho Dispatcher b·∫±ng c√°ch cho ph√©p h·ªç t·∫°o m·ªôt L·ªánh Giao Tr·∫£ duy nh·∫•t cho nhi·ªÅu container c√≥ chung c√°c thu·ªôc t√≠nh (c√πng h√£ng t√†u, c√πng ƒë·ªãa ƒëi·ªÉm d·ª° h√†ng...).
- **AC2 & AC3:** Gi·∫£m thi·ªÉu s·ªë b∆∞·ªõc v√† th·ªùi gian ƒë·ªÉ t·∫°o m·ªôt y√™u c·∫ßu street-turn b·∫±ng c√°ch cho ph√©p ng∆∞·ªùi d√πng gh√©p n·ªëi ngay l·∫≠p t·ª©c m·ªôt L·ªánh Giao Tr·∫£ m·ªõi v·ªõi c√°c L·ªánh L·∫•y R·ªóng hi·ªán c√≥ ho·∫∑c m·ªôt L·ªánh L·∫•y R·ªóng m·ªõi ngay trong c√πng m·ªôt giao di·ªán.

**4. Vai tr√≤ tham gia (Actors)**

- **Th·ª±c hi·ªán ch√≠nh:** ƒêi·ªÅu ph·ªëi vi√™n (Dispatcher).

---

### **Ph·∫ßn A: Acceptance Criteria 1 - H·ªó Tr·ª£ Nh·∫≠p Nhi·ªÅu Container**

**1. Lu·ªìng ch√≠nh (Happy Path) & Thi·∫øt k·∫ø UIUX:**

1. **[Dispatcher]** M·ªü form "Th√™m L·ªánh Giao Tr·∫£".
2. **Thi·∫øt k·∫ø m·ªõi cho √¥ "S·ªë Container":**
    - √î <Input> c≈© s·∫Ω ƒë∆∞·ª£c thay th·∫ø b·∫±ng m·ªôt **component nh·∫≠p li·ªáu d·∫°ng "tag" ho·∫∑c "badge"**.
    - **Th√†nh ph·∫ßn:**
        - M·ªôt √¥ <Input> ch√≠nh ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p s·ªë container.
        - Khi ng∆∞·ªùi d√πng nh·∫≠p xong m·ªôt s·ªë container v√† nh·∫•n Enter ho·∫∑c Tab:
            - H·ªá th·ªëng s·∫Ω ch·∫°y validation (ISO6346, check tr√πng trong ch√≠nh l·ªánh n√†y).
            - N·∫øu h·ª£p l·ªá, s·ªë container ƒë√≥ s·∫Ω ƒë∆∞·ª£c bi·∫øn th√†nh m·ªôt **"th·∫ª" (badge)** m√†u xanh c√≥ icon ch·ªØ X nh·ªè b√™n c·∫°nh.
            - Con tr·ªè chu·ªôt s·∫Ω quay l·∫°i √¥ input ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p s·ªë ti·∫øp theo.
        - Khu v·ª±c b√™n tr√™n ho·∫∑c b√™n c·∫°nh √¥ input s·∫Ω hi·ªÉn th·ªã c√°c th·∫ª container ƒë√£ ƒë∆∞·ª£c th√™m.
    - **Hi·ªÉn th·ªã l·ªói:** N·∫øu nh·∫≠p tr√πng ho·∫∑c sai ƒë·ªãnh d·∫°ng, m·ªôt th√¥ng b√°o l·ªói s·∫Ω hi·ªán ngay b√™n d∆∞·ªõi √¥ input.
3. **Thay ƒë·ªïi B·ªë c·ª•c Form:**
    - Do √¥ nh·∫≠p container gi·ªù ƒë√¢y c√≥ th·ªÉ chi·∫øm nhi·ªÅu kh√¥ng gian h∆°n, **to√†n b·ªô layout c·ªßa Dialog c·∫ßn ƒë∆∞·ª£c thi·∫øt k·∫ø l·∫°i theo d·∫°ng 1 c·ªôt**, c√°c tr∆∞·ªùng s·∫Ω x·∫øp ch·ªìng l√™n nhau thay v√¨ 2 c·ªôt nh∆∞ tr∆∞·ªõc. ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n v√† d·ªÖ ƒë·ªçc tr√™n m·ªçi k√≠ch th∆∞·ªõc.

**2. M√¥ t·∫£ Backend & CSDL:**

- **C·∫≠p nh·∫≠t CSDL:**
    - Trong b·∫£ng import_containers (L·ªánh Giao Tr·∫£), c·ªôt container_number (ki·ªÉu TEXT) s·∫Ω ƒë∆∞·ª£c ƒë·ªïi t√™n v√† ki·ªÉu d·ªØ li·ªáu:
        
        ```
        -- SQL Script ƒë·ªÉ ch·∫°y tr√™n Supabase
        ALTER TABLE public.import_containers
        RENAME COLUMN container_number TO container_numbers;
        
        ALTER TABLE public.import_containers
        ALTER COLUMN container_numbers TYPE TEXT[] USING string_to_array(container_numbers, ',');
        -- ƒê·ªïi sang ki·ªÉu m·∫£ng TEXT. string_to_array ch·ªâ l√† v√≠ d·ª• ƒë·ªÉ chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu c≈© n·∫øu c√≥.
        
        COMMENT ON COLUMN public.import_containers.container_numbers IS 'M·∫£ng l∆∞u danh s√°ch c√°c s·ªë container cho l·ªánh giao tr·∫£ h√†ng lo·∫°t.';
        ```
        
- **C·∫≠p nh·∫≠t Logic:**
    - Server Action addDropOffOrder gi·ªù s·∫Ω nh·∫≠n m·ªôt m·∫£ng container_numbers thay v√¨ m·ªôt chu·ªói ƒë∆°n.
    - Tr∆∞·ªõc khi INSERT, Server Action ph·∫£i th·ª±c hi·ªán m·ªôt v√≤ng l·∫∑p ƒë·ªÉ validate t·ª´ng s·ªë container trong m·∫£ng (check tr√πng trong CSDL v·ªõi c√°c l·ªánh kh√°c).
    - H√†m t√≠nh ƒëi·ªÉm gh√©p n·ªëi c≈©ng c·∫ßn ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ x·ª≠ l√Ω vi·ªác so kh·ªõp v·ªõi m·ªôt l·ªánh ch·ª©a nhi·ªÅu container.

---

### **Ph·∫ßn B: Acceptance Criteria 2 & 3 - Gh√©p N·ªëi T·ª©c Th√¨**

**1. Lu·ªìng ch√≠nh (Happy Path) & Thi·∫øt k·∫ø UIUX:**

1. **[UI] Khu v·ª±c M·ªõi tr√™n Form "Th√™m L·ªánh Giao Tr·∫£":**
    - B√™n d∆∞·ªõi ph·∫ßn "T√πy ch·ªçn kh√°c", th√™m m·ªôt khu v·ª±c m·ªõi ƒë∆∞·ª£c bao b·ªçc trong <fieldset> v·ªõi ti√™u ƒë·ªÅ: **"Gh√©p n·ªëi Nhanh (T√πy ch·ªçn)"**.
    - B√™n trong, c√≥ hai n√∫t Radio Button ƒë·ªÉ ng∆∞·ªùi d√πng l·ª±a ch·ªçn:
        - üîò Ch·ªçn t·ª´ L·ªánh L·∫•y R·ªóng ƒë√£ c√≥
        - üîò T·∫°o L·ªánh L·∫•y R·ªóng m·ªõi
2. **Lu·ªìng "Ch·ªçn L·ªánh ƒë√£ c√≥":**
    - Khi ng∆∞·ªùi d√πng ch·ªçn radio button n√†y, m·ªôt **<Combobox> t√¨m ki·∫øm** s·∫Ω hi·ªán ra.
    - **Placeholder:** "T√¨m theo S·ªë Booking ho·∫∑c ƒê·ªãa ƒëi·ªÉm...".
    - **Logic:** Combobox n√†y s·∫Ω fetch v√† hi·ªÉn th·ªã danh s√°ch c√°c "L·ªánh L·∫•y R·ªóng" ƒëang AVAILABLE (ch∆∞a ƒë∆∞·ª£c gh√©p c·∫∑p).
    - Khi ng∆∞·ªùi d√πng ch·ªçn m·ªôt ho·∫∑c nhi·ªÅu l·ªánh, ch√∫ng s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã d∆∞·ªõi d·∫°ng c√°c th·∫ª nh·ªè.
3. **Lu·ªìng "T·∫°o L·ªánh m·ªõi":**
    - Khi ng∆∞·ªùi d√πng ch·ªçn radio button n√†y, m·ªôt n√∫t **"+ T·∫°o L·ªánh L·∫•y R·ªóng ƒëi k√®m"** s·∫Ω xu·∫•t hi·ªán.
    - Khi nh·∫•n n√∫t n√†y, **animation tr∆∞·ª£t ngang** s·∫Ω di·ªÖn ra:
        - Form "Th√™m L·ªánh Giao Tr·∫£" hi·ªán t·∫°i (c·ªôt tr√°i) s·∫Ω co l·∫°i c√≤n kho·∫£ng 45-50% chi·ªÅu r·ªông.
        - Form "Th√™m L·ªánh L·∫•y R·ªóng" (c·ªôt ph·∫£i) s·∫Ω tr∆∞·ª£t ra t·ª´ b√™n ph·∫£i, chi·∫øm ph·∫ßn c√≤n l·∫°i c·ªßa Dialog.
        - C·∫£ hai form ƒë·ªÅu hi·ªÉn th·ªã song song.
    - **T√≠nh nƒÉng th√¥ng minh tr√™n form L·∫•y R·ªóng (m·ªõi):**
        - M·ªôt m·ª•c m·ªõi **"Ch·ªçn Container ƒë·ªÉ t√°i s·ª≠ d·ª•ng (*)"** s·∫Ω xu·∫•t hi·ªán.
        - M·ª•c n√†y l√† m·ªôt **<Combobox> cho ph√©p ch·ªçn nhi·ªÅu container**.
        - **Danh s√°ch c√°c l·ª±a ch·ªçn** trong Combobox n√†y ch√≠nh l√† danh s√°ch c√°c container m√† ng∆∞·ªùi d√πng ƒë√£ nh·∫≠p ·ªü form L·ªánh Giao Tr·∫£ b√™n tr√°i.
        - C√≥ m·ªôt n√∫t nh·ªè **"Ch·ªçn t·∫•t c·∫£"** ƒë·ªÉ t·ª± ƒë·ªông th√™m to√†n b·ªô container t·ª´ LGT v√†o LLR.
4. **H√†nh ƒë·ªông cu·ªëi c√πng:**
    - ·ªû d∆∞·ªõi c√πng c·ªßa Dialog l·ªõn (ch·ª©a c·∫£ 1 ho·∫∑c 2 form), n√∫t "L∆∞u" s·∫Ω ƒë·ªïi th√†nh **"T·∫°o L·ªánh & G·ª≠i Y√™u c·∫ßu Gh√©p n·ªëi"** n·∫øu ng∆∞·ªùi d√πng ƒë√£ th·ª±c hi·ªán m·ªôt h√†nh ƒë·ªông gh√©p n·ªëi.
    - Khi nh·∫•n, Server Action s·∫Ω th·ª±c hi·ªán ƒë·ªìng th·ªùi: t·∫°o LGT, t·∫°o/c·∫≠p nh·∫≠t LLR, v√† ngay l·∫≠p t·ª©c t·∫°o m·ªôt street_turn_request ƒë·ªÉ g·ª≠i cho LTA Admin.

**2. M√¥ t·∫£ Backend & CSDL:**

- **C·∫≠p nh·∫≠t CSDL:** code SQL
    
    
    IGNORE_WHEN_COPYING_START
    
    IGNORE_WHEN_COPYING_END
    
    ```
    -- Th√™m v√†o b·∫£ng L·ªánh L·∫•y R·ªóng (export_bookings)
    ALTER TABLE public.export_bookings
    ADD COLUMN paired_dropoff_order_id UUID REFERENCES public.import_containers(id) ON DELETE SET NULL;
    
    ALTER TABLE public.export_bookings
    ADD COLUMN requested_container_numbers TEXT[];
    
    COMMENT ON COLUMN public.export_bookings.paired_dropoff_order_id IS 'Li√™n k·∫øt ƒë·∫øn L·ªánh Giao Tr·∫£ m√† n√≥ ƒë∆∞·ª£c gh√©p c·∫∑p ngay khi t·∫°o.';
    COMMENT ON COLUMN public.export_bookings.requested_container_numbers IS 'Danh s√°ch c√°c s·ªë container c·ª• th·ªÉ ƒë∆∞·ª£c y√™u c·∫ßu cho vi·ªác t√°i s·ª≠ d·ª•ng.';
    ```
    
- **C·∫≠p nh·∫≠t Logic:**
    - C·∫ßn m·ªôt **Server Action m·ªõi, ph·ª©c h·ª£p h∆°n**, v√≠ d·ª• createPairedOrdersAndRequest.
    - Action n√†y s·∫Ω ƒë∆∞·ª£c bao b·ªçc trong m·ªôt **giao d·ªãch CSDL (transaction)** ƒë·ªÉ ƒë·∫£m b·∫£o t·∫•t c·∫£ c√°c h√†nh ƒë·ªông (INSERT LGT, INSERT LLR, INSERT street_turn_request, UPDATE tr·∫°ng th√°i) ƒë·ªÅu th√†nh c√¥ng ho·∫∑c th·∫•t b·∫°i c√πng nhau.